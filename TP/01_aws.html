<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Pratique de l'Autoscaling sur Amazon EC2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Travaux Pratique des services d'autoscaling sur Amazon Web Service.">
<meta name="author" content="Bertrand Tornil">

<link href="swiss.css" rel="stylesheet"></link>
</head>
<body><h1>Atelier AWS</h1>
<h2>La doc en ligne</h2>
<p><a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html">http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html</a></p>
<h2>Installer AWS CLI</h2>
<p>Pour info : <a href="https://github.com/aws/aws-cli">https://github.com/aws/aws-cli</a></p>
<pre><code>($sudo apt-get install -y python-pip)
$ sudo pip install awscli
...
$ vi .aws-config
...
$ cat .aws-config
[default]
aws_access_key_id = &lt;access key id&gt;
aws_secret_access_key = &lt;secret access key&gt;
region = us-east-1
$ chmod 600 $HOME/.aws-config
$ aws ec2 describe-regions
{
    &quot;Regions&quot;: [
        {
            &quot;Endpoint&quot;: &quot;ec2.eu-west-1.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;eu-west-1&quot;
        },
        {
            &quot;Endpoint&quot;: &quot;ec2.sa-east-1.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;sa-east-1&quot;
        },
        {
            &quot;Endpoint&quot;: &quot;ec2.us-east-1.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;us-east-1&quot;
        },
        {
            &quot;Endpoint&quot;: &quot;ec2.ap-northeast-1.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;ap-northeast-1&quot;
        },
        {
            &quot;Endpoint&quot;: &quot;ec2.us-west-2.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;us-west-2&quot;
        },
        {
            &quot;Endpoint&quot;: &quot;ec2.us-west-1.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;us-west-1&quot;
        },
        {
            &quot;Endpoint&quot;: &quot;ec2.ap-southeast-1.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;ap-southeast-1&quot;
        },
        {
            &quot;Endpoint&quot;: &quot;ec2.ap-southeast-2.amazonaws.com&quot;,
            &quot;RegionName&quot;: &quot;ap-southeast-2&quot;
        }
    ]
}</code></pre>
<h3>Pratique : l&#39;autocompletion</h3>
<pre><code class="lang-bash">complete -C aws_completer aws</code></pre>
<h2>Commencer par se créer une paire de clés</h2>
<pre><code class="lang-bash">$ aws ec2 create-key-pair help</code></pre>
<p>Astuce pour afficher clairement la clé... et panipuler plus facilement du json en ligne de commande.</p>
<p>Installer jq : <a href="http://stedolan.github.io/jq/">http://stedolan.github.io/jq/</a></p>
<h2>Lancement de notre première instance</h2>
<h3>choix d&#39;une ami</h3>
<p>pour ubuntu 12.04 (LTS), c&#39;est <a href="https://cloud-images.ubuntu.com/precise/current/">https://cloud-images.ubuntu.com/precise/current/</a></p>
<p>Nous allons prendre l&#39;image du système 64 bits, en root store sur EBS : ami-7daee114</p>
<pre><code>aws ec2 run-instances help</code></pre>
<p>Penser à note son instance-id.</p>
<h2>Se connecter à l&#39;instance</h2>
<p>Récupérer le dns public.</p>
<pre><code>aws ec2 describe-instances help</code></pre>
<p>et se connecter</p>
<pre><code>ssh ubuntu@ec2-xx-yy-zz-tt.compute-1.amazonaws.com -i my-key-pair.pem -v
...
...
[ubuntu@ip-xx-yy-zz-tt ~]$</code></pre>
<p>On peut en lancer une deuxième, une troisième ... La commande describe-instances nous fournira les informations de ces instances.</p>
<h2>Stopper une instance</h2>
<pre><code>aws ec2 stop-instance help</code></pre>
<h2>terminer une instance</h2>
<pre><code>aws ec2 terminate-instances help</code></pre>
<h2>Mumuse avec les EBS (Elasctic Block Storage)</h2>
<p>Dans la description de notre instance, nous notons</p>
<pre><code>&quot;BlockDeviceMappings&quot;: [
                        {
                            &quot;DeviceName&quot;: &quot;/dev/sda1&quot;,
                            &quot;Ebs&quot;: {
                                &quot;Status&quot;: &quot;attached&quot;,
                                &quot;DeleteOnTermination&quot;: true,
                                &quot;VolumeId&quot;: &quot;vol-21726d61&quot;,
                                &quot;AttachTime&quot;: &quot;2013-09-02T13:25:36.000Z&quot;
                            }
                        }
                    ],</code></pre>
<p>Nous pouvons le détacher</p>
<p>Au préalable, on le démonte.</p>
<pre><code># umount -d /dev/sda</code></pre>
<p>Et depuis la ligne de commande :</p>
<pre><code>aws ec2 detach-volume help</code></pre>
<h2>Elastic Load Balancer</h2>
<p>On déclare un ELB nommé upicardie-asdemo_VOTRENOM sur la zone us-east-1d, qui écoute sur le port 80 et qui répartit les requêtes sur le port 80 des instances :</p>
<pre><code>aws elb create-load-balancer \
  --load-balancer-name upicardie-asdemo_VOTRENOM \
  --availability-zones us-east-1d \
  --listeners &quot;LoadBalancerPort=80,InstancePort=80,Protocol=http&quot;
{
    &quot;DNSName&quot;: &quot;upicardie-asdemo1-2087259529.us-east-1.elb.amazonaws.com&quot;
}</code></pre>
<p>Penser à ajouter les availability zones accéssibles à notre ELB : les micro instances sont en 1a. L&#39;ELB écoute en 1b.</p>
<pre><code>aws elb enable-availability-zones-for-load-balancer --load-balancer-name upicardie-asdemo_VOTRENOM --availability-zones us-east-1a</code></pre>
<p>Attachons-lui les 2 instances que nous avons créées.</p>
<pre><code>aws elb register-instances-with-load-balancer help</code></pre>
<h2>Excercice</h2>
<p>Installer un site web quelconque sur 3 instances, rattachées à un ELB. Lancer un test de charge naif (ou pas) afin d&#39;observer les logs sur chaque machine.</p>
<h2>La même chose en console WEB (ouf!)</h2>
<p>Amazon est un des pioniers du Web. Il aurait été étonnant de ne pas avoir une façon plus visuelle d&#39;utiliser les services d&#39;AWS.</p>
<p>C&#39;est possible à l&#39;addresse : <a href="https://180843797005.signin.aws.amazon.com/console/">https://180843797005.signin.aws.amazon.com/console/</a></p>
<p>Mais vous allez devoir vous créer votre login</p>
<pre><code>aws iam create-login-profile help</code></pre>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32527212-2']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</head>