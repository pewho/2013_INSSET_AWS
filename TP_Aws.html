<!DOCTYPE html>
<html>
<title>TP AWS</title>

<xmp theme="simplex" style="display:none;">


La doc en ligne
---------------

http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html



Installer AWS CLI
-----------------

Pour info : https://github.com/aws/aws-cli

```
($sudo apt-get install -y python-pip)
$ sudo pip install awscli
...
$ vi .aws-config
...
$ cat .aws-config
[default]
aws_access_key_id = <access key id>
aws_secret_access_key = <secret access key>
region = us-east-1
$ chmod 600 $HOME/.aws-config
$ aws ec2 describe-regions
{
    "Regions": [
        {
            "Endpoint": "ec2.eu-west-1.amazonaws.com",
            "RegionName": "eu-west-1"
        },
        {
            "Endpoint": "ec2.sa-east-1.amazonaws.com",
            "RegionName": "sa-east-1"
        },
        {
            "Endpoint": "ec2.us-east-1.amazonaws.com",
            "RegionName": "us-east-1"
        },
        {
            "Endpoint": "ec2.ap-northeast-1.amazonaws.com",
            "RegionName": "ap-northeast-1"
        },
        {
            "Endpoint": "ec2.us-west-2.amazonaws.com",
            "RegionName": "us-west-2"
        },
        {
            "Endpoint": "ec2.us-west-1.amazonaws.com",
            "RegionName": "us-west-1"
        },
        {
            "Endpoint": "ec2.ap-southeast-1.amazonaws.com",
            "RegionName": "ap-southeast-1"
        },
        {
            "Endpoint": "ec2.ap-southeast-2.amazonaws.com",
            "RegionName": "ap-southeast-2"
        }
    ]
}
```

### Pratique : l'autocompletion

```bash
complete -C aws_completer aws
```


On commence Par se créer une paire de clés
------------------------------------------

```bash
$ aws ec2 create-key-pair --key-name MyKeyPair

{
    "KeyPair": {
        "KeyMaterial": "-----BEGIN RSA PRIVATE KEY-----\nMIIEogIBAAKCAQEAgDbY5Hzlv+wP4nTVXkwRHemd3/OLo/O6u+kI2UloHqN6mZLP+XoFcEAmNmM0\n3sA/mfv0B9fKktSUqnAEPlygS35P1xJhUXqvdFhh4m7mF+D7naPPHWcg581sdhfqEQU1uMcFq+14\nfTgkQRCLkoNNsf3c4O1KxhJ6etHFxcqr/V104PnOPGlWWni+kIMyMP/+CvzzKCZkkL/EUk6LDH4T\nHqG4nDmEd4u0oNPakWd1nX26hfYN61IhkNedtqU9CnJPHBFRbl+BZbllB4ZkxYn6QHi5t7J0Lj26\nruq6URfKLIO4ZOcZ35ZARSFB4nYtU6tbw78sE0jJqZ6ibwHyPhw8fwIDAQABAoIBAEGs1pjjqUQQ\nBWr4cbslt7bczfPDawoGdOaATfoPcfgPwWMdIs8lw9dl5K0DUDexvmJ//tZtoORpY+WSD3pqM+m3\nv+npDlSQRYORKkK0j8Q3iGuNVzA2fVJ/lUlAorMpOgV2XN9eetOZiGiTswrPm2LLKPNGWYDwQjDb\ndzUDxem300kdPZcGiiW6OIIF39s0cHdYSurLlfFGBgT1YZUQQI8AyAZOA/uI5gzlXHo6pmOGc61Y\nnIGqAYV3k8eCsEag9XMyrAih1DiuSMEUzwXImPHuFQTB/Z28rhPPbdQ3mioHJBRDn3wGRz233q44\n5ZHGsi/XdeA2oNAIIg+20LFVhdECgYEA1jnngYbv30JPO/IAQdAjM4r4bV5adqQRhsZFeFcjI1pL\n6JXHnuBBN69z5liCICRLfWHtEwUXDbt/9tZmmG6Qp5SZdPSncmAbzsDuA7nKKrnhdoNDw4V8MN++\n+Hn+T0ezJp8dXNB3EnDiLvO71sunJMTAIxKjPejFG6SsqALWrSMCgYEAmTdB1XgOCdgl3P+8/Og0\nM3qwZGTbX641ug30QBgYmDKA3D+vLRBeGtxU+j/y41Ah2W016amtdM7KgMTVdB0ZjSR70TmaETrD\nkW449q0J/UrH9DmcOpUf8qVS8QwG/fhH/VElLKiWGitulHrZPVSSBomLpJKOUzHnSGl6ZO+m7vUC\ngYA5YVUjGpORh19VvSJYfnmPSr/z+3vbn2KaaO0eqKhexcbjS4smgQa29aXjov1nwpD9yocHuytL\noFdMNG1SkvroCCN6cjWPqzKHlKGsGc2O2C8N4Wb7Lfvv016Bi5uUfK39wEzLGYNrSxUqYlqD1BS3\nAoQ8YLec04ZIOzmL3wbFZQKBgHAeZYim3+8IQzzj0BJqgbiiMW5l97qeqyZJi9FTULwfSPjjiXc6\noQKa9XxjS4RYYUzQhEFHL21o3fs5DtJ3cPk+F3VV545wKCjGNd0dZ0/5ZzUq605bThOsM3O9T2iO\nRW/z73YssBraaYMyGsKsnmc2Q//cV1Y+EHeG6E/wp4H5AoGAT/jpdHo6hjYDd6z8WJT6zuyecT39\nl4oB72CO6PCJXLLtTj85brYLP6mZyecOvD4a7Zr97NcmA4aUZtv7ERHoHSRhyOm1ePHaV2i7JFfo\nHvc01+KCAJPx8txqvHvqKfNm2aMeok7FVPSB1vbdgnBRnGJiqYQ5GgrxH0Gc3DXTG7A=\n-----END RSA PRIVATE KEY-----",
        "KeyName": "MyKeyPair",
        "KeyFingerprint": "24:86:89:71:68:af:3e:00:49:15:96:06:2d:f3:2e:96:da:66:6e:d8"
    }
}

$ vi my-key-pair.pem
$ cat my-key-pair.pem
-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAgDbY5Hzlv+wP4nTVXkwRHemd3/OLo/O6u+kI2UloHqN6mZLP+XoFcEAmNmM0
3sA/mfv0B9fKktSUqnAEPlygS35P1xJhUXqvdFhh4m7mF+D7naPPHWcg581sdhfqEQU1uMcFq+14
fTgkQRCLkoNNsf3c4O1KxhJ6etHFxcqr/V104PnOPGlWWni+kIMyMP/+CvzzKCZkkL/EUk6LDH4T
HqG4nDmEd4u0oNPakWd1nX26hfYN61IhkNedtqU9CnJPHBFRbl+BZbllB4ZkxYn6QHi5t7J0Lj26
ruq6URfKLIO4ZOcZ35ZARSFB4nYtU6tbw78sE0jJqZ6ibwHyPhw8fwIDAQABAoIBAEGs1pjjqUQQ
BWr4cbslt7bczfPDawoGdOaATfoPcfgPwWMdIs8lw9dl5K0DUDexvmJ//tZtoORpY+WSD3pqM+m3
v+npDlSQRYORKkK0j8Q3iGuNVzA2fVJ/lUlAorMpOgV2XN9eetOZiGiTswrPm2LLKPNGWYDwQjDb
dzUDxem300kdPZcGiiW6OIIF39s0cHdYSurLlfFGBgT1YZUQQI8AyAZOA/uI5gzlXHo6pmOGc61Y
nIGqAYV3k8eCsEag9XMyrAih1DiuSMEUzwXImPHuFQTB/Z28rhPPbdQ3mioHJBRDn3wGRz233q44
5ZHGsi/XdeA2oNAIIg+20LFVhdECgYEA1jnngYbv30JPO/IAQdAjM4r4bV5adqQRhsZFeFcjI1pL
6JXHnuBBN69z5liCICRLfWHtEwUXDbt/9tZmmG6Qp5SZdPSncmAbzsDuA7nKKrnhdoNDw4V8MN++
+Hn+T0ezJp8dXNB3EnDiLvO71sunJMTAIxKjPejFG6SsqALWrSMCgYEAmTdB1XgOCdgl3P+8/Og0
M3qwZGTbX641ug30QBgYmDKA3D+vLRBeGtxU+j/y41Ah2W016amtdM7KgMTVdB0ZjSR70TmaETrD
kW449q0J/UrH9DmcOpUf8qVS8QwG/fhH/VElLKiWGitulHrZPVSSBomLpJKOUzHnSGl6ZO+m7vUC
gYA5YVUjGpORh19VvSJYfnmPSr/z+3vbn2KaaO0eqKhexcbjS4smgQa29aXjov1nwpD9yocHuytL
oFdMNG1SkvroCCN6cjWPqzKHlKGsGc2O2C8N4Wb7Lfvv016Bi5uUfK39wEzLGYNrSxUqYlqD1BS3
AoQ8YLec04ZIOzmL3wbFZQKBgHAeZYim3+8IQzzj0BJqgbiiMW5l97qeqyZJi9FTULwfSPjjiXc6
oQKa9XxjS4RYYUzQhEFHL21o3fs5DtJ3cPk+F3VV545wKCjGNd0dZ0/5ZzUq605bThOsM3O9T2iO
RW/z73YssBraaYMyGsKsnmc2Q//cV1Y+EHeG6E/wp4H5AoGAT/jpdHo6hjYDd6z8WJT6zuyecT39
l4oB72CO6PCJXLLtTj85brYLP6mZyecOvD4a7Zr97NcmA4aUZtv7ERHoHSRhyOm1ePHaV2i7JFfo
Hvc01+KCAJPx8txqvHvqKfNm2aMeok7FVPSB1vbdgnBRnGJiqYQ5GgrxH0Gc3DXTG7A=
-----END RSA PRIVATE KEY-----
```

Astuce pour afficher clairement la clé... et panipuler plus facilement du json en ligne de commande.

Installer jq : http://stedolan.github.io/jq/

```
aws ec2 create-key-pair --key-name kp_test | jq '.KeyPair.KeyMaterial' | xargs -0 printf
```


Lancement de notre première instance
------------------------------------

### choix d'une ami

pour ubuntu 12.04 (LTS), c'est https://cloud-images.ubuntu.com/precise/current/

Nous allons prendre l'image du système 64 bits, en root store sur EBS - ami : ami-7daee114. D'où la commande :


```
aws ec2 run-instances --image-id ami-7daee114 --instance-type t1.micro --region us-east-1 --key MyKeyPair
{
    "OwnerId": "511122800347",
    "ReservationId": "r-f6edcf94",
    "Groups": [
        {
            "GroupName": "upicardie-asdemo-web",
            "GroupId": "sg-6563ed0e"
        }
    ],
    "Instances": [
        {
            "Monitoring": {
                "State": "disabled"
            },
            "PublicDnsName": null,
            "KernelId": "aki-407d9529",
            "State": {
                "Code": 0,
                "Name": "pending"
            },
            "EbsOptimized": false,
            "LaunchTime": "2013-08-29T20:18:10.000Z",
            "ProductCodes": [],
            "StateTransitionReason": null,
            "InstanceId": "i-cb3d58a6",
            "ImageId": "ami-8c1fece5",
            "PrivateDnsName": null,
            "KeyName": "MyKeyPair",
            "SecurityGroups": [
                {
                    "GroupName": "upicardie-asdemo-web",
                    "GroupId": "sg-6563ed0e"
                }
            ],
            "ClientToken": null,
            "InstanceType": "t1.micro",
            "NetworkInterfaces": [],
            "Placement": {
                "Tenancy": "default",
                "GroupName": null,
                "AvailabilityZone": "us-east-1a"
            },
            "Hypervisor": "xen",
            "BlockDeviceMappings": [],
            "Architecture": "i386",
            "StateReason": {
                "Message": "pending",
                "Code": "pending"
            },
            "RootDeviceName": "/dev/sda1",
            "VirtualizationType": "paravirtual",
            "RootDeviceType": "ebs",
            "AmiLaunchIndex": 0
        }
    ]
}
```

On note le `"PublicDnsName": null`, ce qui signifie que l'instance n'a pour le moment pas d'entrée DNS, puisqu'elle est en train de se lance (statut `pending`).


## se connecter à l'instance

Quelques instants plus tard, nous allons redemander :

```
aws ec2 describe-instances
{
    "Reservations": [
        {
            "OwnerId": "511122800347",
            "ReservationId": "r-f6edcf94",
            "Groups": [
                {
                    "GroupName": "upicardie-asdemo-web",
                    "GroupId": "sg-6563ed0e"
                }
            ],
            "Instances": [
                {
                    "Monitoring": {
                        "State": "disabled"
                    },
                    "PublicDnsName": "ec2-107-22-76-96.compute-1.amazonaws.com",
                    "RootDeviceType": "ebs",
                    "State": {
                        "Code": 16,
                        "Name": "running"
                    },
                    "EbsOptimized": false,
                    "LaunchTime": "2013-08-29T20:18:10.000Z",
                    "PublicIpAddress": "107.22.76.96",
                    "PrivateIpAddress": "10.202.59.53",
                    "ProductCodes": [],
                    "StateTransitionReason": null,
                    "InstanceId": "i-cb3d58a6",
                    "ImageId": "ami-8c1fece5",
                    "PrivateDnsName": "ip-10-202-59-53.ec2.internal",
                    "KeyName": "MyKeyPair",
                    "SecurityGroups": [
                        {
                            "GroupName": "upicardie-asdemo-web",
                            "GroupId": "sg-6563ed0e"
                        }
                    ],
                    "ClientToken": null,
                    "InstanceType": "t1.micro",
                    "NetworkInterfaces": [],
                    "Placement": {
                        "Tenancy": "default",
                        "GroupName": null,
                        "AvailabilityZone": "us-east-1a"
                    },
                    "Hypervisor": "xen",
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/sda1",
                            "Ebs": {
                                "Status": "attached",
                                "DeleteOnTermination": true,
                                "VolumeId": "vol-8fa0b6cf",
                                "AttachTime": "2013-08-29T20:18:14.000Z"
                            }
                        }
                    ],
                    "Architecture": "i386",
                    "KernelId": "aki-407d9529",
                    "RootDeviceName": "/dev/sda1",
                    "VirtualizationType": "paravirtual",
                    "AmiLaunchIndex": 0
                }
            ]
        }
    ]
}
```

Et Bam ! la machine est prête (statut "running"). Notons le DNS public (pour nous c'est `ec2-107-22-76-96.compute-1.amazonaws.com`).

Attention aux machines des petits camarades. Vous les verrez :)

Normalement, nous avons maintenant tout ce qu'il faut pour nous connecter à notre toute première instance en SSH. Chaque système a ses petites habitudes. Sous ubuntu, c'est l'user ubuntu qui doit se connecter.

```
ssh ubuntu@ec2-107-22-76-96.compute-1.amazonaws.com -i my-key-pair.pem -v
...
...
[ubuntu@ip-10-202-59-53 ~]$
```

On peut en lancer une deuxième, une troisième ... La commande describe-instances nous fournira les informations de ces instances.



## Stopper une instance

```
aws ec2 stop-instance --instance-id i-cb3d58a6
{
    "Reservations": [
        {
            "OwnerId": "511122800347",
            "ReservationId": "r-f6edcf94",
            "Groups": [
                {
                    "GroupName": "upicardie-asdemo-web",
                    "GroupId": "sg-6563ed0e"
                }
            ],
            "Instances": [
                {
                    "Monitoring": {
                        "State": "disabled"
                    },
                    "PublicDnsName": "ec2-107-22-76-96.compute-1.amazonaws.com",
                    "RootDeviceType": "ebs",
                    "State": {
                        "Code": 16,
                        "Name": "running"
                    },
                    "EbsOptimized": false,
                    "LaunchTime": "2013-08-29T20:18:10.000Z",
                    "PublicIpAddress": "107.22.76.96",
                    "PrivateIpAddress": "10.202.59.53",
                    "ProductCodes": [],
                    "StateTransitionReason": null,
                    "InstanceId": "i-cb3d58a6",
                    "ImageId": "ami-8c1fece5",
                    "PrivateDnsName": "ip-10-202-59-53.ec2.internal",
                    "KeyName": "MyKeyPair",
                    "SecurityGroups": [
                        {
                            "GroupName": "upicardie-asdemo-web",
                            "GroupId": "sg-6563ed0e"
                        }
                    ],
                    "ClientToken": null,
                    "InstanceType": "t1.micro",
                    "NetworkInterfaces": [],
                    "Placement": {
                        "Tenancy": "default",
                        "GroupName": null,
                        "AvailabilityZone": "us-east-1a"
                    },
                    "Hypervisor": "xen",
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/sda1",
                            "Ebs": {
                                "Status": "attached",
                                "DeleteOnTermination": true,
                                "VolumeId": "vol-8fa0b6cf",
                                "AttachTime": "2013-08-29T20:18:14.000Z"
                            }
                        }
                    ],
                    "Architecture": "i386",
                    "KernelId": "aki-407d9529",
                    "RootDeviceName": "/dev/sda1",
                    "VirtualizationType": "paravirtual",
                    "AmiLaunchIndex": 0
                }
            ]
        }
    ]
}
```

## terminer une instance

```
aws ec2 terminate-instances --instance-id i-cb3d58a6
```

## Mumuse avec les EBS (Elasctic Block Storage)

Dans la description de notre instance, nous notons

```
"BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/sda1",
                            "Ebs": {
                                "Status": "attached",
                                "DeleteOnTermination": true,
                                "VolumeId": "vol-21726d61",
                                "AttachTime": "2013-09-02T13:25:36.000Z"
                            }
                        }
                    ],
```

Nous pouvons le détacher

Au préalable, on le démonte.

```
umount -d /dev/sda
```

Et depuis la ligne de commande :

```
aws ec2 detach-volume --instance-id i-3a0ba252 --volume-id vol-21726d61
```


## Elastic Load Balancer

On déclare un ELB nommé upicardie-asdemo1 sur la zone us-east-1d, qui écoute sur le port 80 et qui répartit les requêtes sur le port 80 des instances :

```
aws elb create-load-balancer \
  --load-balancer-name upicardie-asdemo1 \
  --availability-zones us-east-1d \
  --listeners "LoadBalancerPort=80,InstancePort=80,Protocol=http"
{
    "DNSName": "upicardie-asdemo1-2087259529.us-east-1.elb.amazonaws.com"
}
```


Penser à ajouter les availability zones accéssibles à notre ELB

```
aws elb enable-availability-zones-for-load-balancer --load-balancer-name upicardie-asdemo --availability-zones us-east-1a
```

Attachons-lui les 2 instances que nous avons créées.

```
aws elb register-instances-with-load-balancer --load-balancer-name upicardie-asdemo1 --instances i-a0eccdc1 i-a0eccda1
```

Excercice
---------

Installer un site web quelconque sur 3 instances, rattachées à un ELB. Lancer un test de charge naif (ou pas) afin d'observer les logs sur chaque machine.



La même chose en console WEB (ouf!)
-----------------------------------

Amazon est un des pioniers du Web. Il aurait été étonnant de ne pas avoir une façon plus visuelle d'utiliser les services d'AWS.

C'est possible à l'addresse : https://YOUR_AMAZON_ID.signin.aws.amazon.com/console/

Mais vous allez devoir vous créer votre login

```
aws iam create-login-profile help
```


</xmp>
<a class="home-link" href="index.html">...</a>
<style>
a.home-link {
    position: fixed;
    top : 4px;
    left: 4px;
    width : 32px;
    height: 32px;
    z-index : 1;
    font-size: 40px;
}
</style>
<script src="strapdown/strapdown.js"></script>
</html>